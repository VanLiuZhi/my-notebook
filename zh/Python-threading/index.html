<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>线程 | 个人网站</title>
    <meta name="description" content="liuzhi notebook">
    <link rel="icon" href="/my-notebook/logo.png">
  <link rel="manifest" href="/my-notebook/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/my-notebook/icons/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/my-notebook/icons/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/my-notebook/assets/css/styles.123d9d81.css" as="style"><link rel="preload" href="/my-notebook/assets/js/app.123d9d81.js" as="script"><link rel="preload" href="/my-notebook/assets/js/55.c4a44499.js" as="script"><link rel="prefetch" href="/my-notebook/assets/css/0.styles.4566aca4.css"><link rel="prefetch" href="/my-notebook/assets/css/10.styles.a96f1b40.css"><link rel="prefetch" href="/my-notebook/assets/css/11.styles.db820060.css"><link rel="prefetch" href="/my-notebook/assets/css/12.styles.27baecdd.css"><link rel="prefetch" href="/my-notebook/assets/css/14.styles.d9b80c01.css"><link rel="prefetch" href="/my-notebook/assets/css/2.styles.8096e6ae.css"><link rel="prefetch" href="/my-notebook/assets/css/6.styles.bb56f95a.css"><link rel="prefetch" href="/my-notebook/assets/css/7.styles.bca84adf.css"><link rel="prefetch" href="/my-notebook/assets/css/8.styles.458330a9.css"><link rel="prefetch" href="/my-notebook/assets/css/9.styles.704fd71b.css"><link rel="prefetch" href="/my-notebook/assets/js/0.4566aca4.js"><link rel="prefetch" href="/my-notebook/assets/js/1.cfe9c73c.js"><link rel="prefetch" href="/my-notebook/assets/js/10.a96f1b40.js"><link rel="prefetch" href="/my-notebook/assets/js/11.db820060.js"><link rel="prefetch" href="/my-notebook/assets/js/12.27baecdd.js"><link rel="prefetch" href="/my-notebook/assets/js/13.80efd87b.js"><link rel="prefetch" href="/my-notebook/assets/js/14.d9b80c01.js"><link rel="prefetch" href="/my-notebook/assets/js/15.17435bac.js"><link rel="prefetch" href="/my-notebook/assets/js/16.d50c8117.js"><link rel="prefetch" href="/my-notebook/assets/js/17.88fa7e8f.js"><link rel="prefetch" href="/my-notebook/assets/js/18.14226db2.js"><link rel="prefetch" href="/my-notebook/assets/js/19.13bb0bf3.js"><link rel="prefetch" href="/my-notebook/assets/js/2.8096e6ae.js"><link rel="prefetch" href="/my-notebook/assets/js/20.307ce541.js"><link rel="prefetch" href="/my-notebook/assets/js/21.152b1a36.js"><link rel="prefetch" href="/my-notebook/assets/js/22.68279112.js"><link rel="prefetch" href="/my-notebook/assets/js/23.ff01dfb3.js"><link rel="prefetch" href="/my-notebook/assets/js/24.fa0648e2.js"><link rel="prefetch" href="/my-notebook/assets/js/25.dc87333b.js"><link rel="prefetch" href="/my-notebook/assets/js/26.2d0b611f.js"><link rel="prefetch" href="/my-notebook/assets/js/27.29f741e0.js"><link rel="prefetch" href="/my-notebook/assets/js/28.7bf8a72f.js"><link rel="prefetch" href="/my-notebook/assets/js/29.c751338c.js"><link rel="prefetch" href="/my-notebook/assets/js/30.2da41fb1.js"><link rel="prefetch" href="/my-notebook/assets/js/31.5ea8c33f.js"><link rel="prefetch" href="/my-notebook/assets/js/32.81e78055.js"><link rel="prefetch" href="/my-notebook/assets/js/33.c5400772.js"><link rel="prefetch" href="/my-notebook/assets/js/34.a7a370ea.js"><link rel="prefetch" href="/my-notebook/assets/js/35.a10cddd6.js"><link rel="prefetch" href="/my-notebook/assets/js/36.721b6807.js"><link rel="prefetch" href="/my-notebook/assets/js/37.3dbaacb9.js"><link rel="prefetch" href="/my-notebook/assets/js/38.c9df08b0.js"><link rel="prefetch" href="/my-notebook/assets/js/39.52a7d225.js"><link rel="prefetch" href="/my-notebook/assets/js/4.3fbd59c2.js"><link rel="prefetch" href="/my-notebook/assets/js/40.eb08522d.js"><link rel="prefetch" href="/my-notebook/assets/js/41.db2e632e.js"><link rel="prefetch" href="/my-notebook/assets/js/42.809cddd0.js"><link rel="prefetch" href="/my-notebook/assets/js/43.e2b5b7f6.js"><link rel="prefetch" href="/my-notebook/assets/js/44.083ad19d.js"><link rel="prefetch" href="/my-notebook/assets/js/45.dc032072.js"><link rel="prefetch" href="/my-notebook/assets/js/46.254fa012.js"><link rel="prefetch" href="/my-notebook/assets/js/47.da9f7663.js"><link rel="prefetch" href="/my-notebook/assets/js/48.f3af0a19.js"><link rel="prefetch" href="/my-notebook/assets/js/49.233bc59c.js"><link rel="prefetch" href="/my-notebook/assets/js/5.595392a5.js"><link rel="prefetch" href="/my-notebook/assets/js/50.43a99bc4.js"><link rel="prefetch" href="/my-notebook/assets/js/51.3ec58d29.js"><link rel="prefetch" href="/my-notebook/assets/js/52.63e821b8.js"><link rel="prefetch" href="/my-notebook/assets/js/53.54a47588.js"><link rel="prefetch" href="/my-notebook/assets/js/54.4762aaf9.js"><link rel="prefetch" href="/my-notebook/assets/js/56.54ce4d8d.js"><link rel="prefetch" href="/my-notebook/assets/js/57.011272a7.js"><link rel="prefetch" href="/my-notebook/assets/js/58.499a8a63.js"><link rel="prefetch" href="/my-notebook/assets/js/59.081a8d2b.js"><link rel="prefetch" href="/my-notebook/assets/js/6.bb56f95a.js"><link rel="prefetch" href="/my-notebook/assets/js/60.70753c61.js"><link rel="prefetch" href="/my-notebook/assets/js/61.9925d9d2.js"><link rel="prefetch" href="/my-notebook/assets/js/62.10bb8a80.js"><link rel="prefetch" href="/my-notebook/assets/js/63.b4b0dc1d.js"><link rel="prefetch" href="/my-notebook/assets/js/64.dc2ae2d2.js"><link rel="prefetch" href="/my-notebook/assets/js/65.280ffa35.js"><link rel="prefetch" href="/my-notebook/assets/js/66.45bab64f.js"><link rel="prefetch" href="/my-notebook/assets/js/67.9c31ffc5.js"><link rel="prefetch" href="/my-notebook/assets/js/68.598b868f.js"><link rel="prefetch" href="/my-notebook/assets/js/69.463adee0.js"><link rel="prefetch" href="/my-notebook/assets/js/7.bca84adf.js"><link rel="prefetch" href="/my-notebook/assets/js/70.5f5d906d.js"><link rel="prefetch" href="/my-notebook/assets/js/71.3cffd9f7.js"><link rel="prefetch" href="/my-notebook/assets/js/72.dbe0f57d.js"><link rel="prefetch" href="/my-notebook/assets/js/73.865e2b8c.js"><link rel="prefetch" href="/my-notebook/assets/js/74.68ee42eb.js"><link rel="prefetch" href="/my-notebook/assets/js/75.26752d45.js"><link rel="prefetch" href="/my-notebook/assets/js/76.92bc5b01.js"><link rel="prefetch" href="/my-notebook/assets/js/77.3b3317b4.js"><link rel="prefetch" href="/my-notebook/assets/js/78.a8c522f1.js"><link rel="prefetch" href="/my-notebook/assets/js/8.458330a9.js"><link rel="prefetch" href="/my-notebook/assets/js/9.704fd71b.js">
    <link rel="stylesheet" href="/my-notebook/assets/css/0.styles.4566aca4.css"><link rel="stylesheet" href="/my-notebook/assets/css/10.styles.a96f1b40.css"><link rel="stylesheet" href="/my-notebook/assets/css/11.styles.db820060.css"><link rel="stylesheet" href="/my-notebook/assets/css/12.styles.27baecdd.css"><link rel="stylesheet" href="/my-notebook/assets/css/14.styles.d9b80c01.css"><link rel="stylesheet" href="/my-notebook/assets/css/2.styles.8096e6ae.css"><link rel="stylesheet" href="/my-notebook/assets/css/6.styles.bb56f95a.css"><link rel="stylesheet" href="/my-notebook/assets/css/7.styles.bca84adf.css"><link rel="stylesheet" href="/my-notebook/assets/css/8.styles.458330a9.css"><link rel="stylesheet" href="/my-notebook/assets/css/9.styles.704fd71b.css"><link rel="stylesheet" href="/my-notebook/assets/css/styles.123d9d81.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/my-notebook/" class="home-link router-link-active"><!----> <span class="site-name">个人网站</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/my-notebook/zh/blog/" class="nav-link">文章</a></div><div class="nav-item"><a href="/my-notebook/zh/Python/" class="nav-link">笔记</a></div><div class="nav-item"><a href="/my-notebook/zh/Collect/" class="nav-link">收藏</a></div><div class="nav-item"><a href="/my-notebook/zh/AboutMe/" class="nav-link">关于我</a></div> <a href="https://github.com/VanLiuZhi/my-notebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/my-notebook/zh/blog/" class="nav-link">文章</a></div><div class="nav-item"><a href="/my-notebook/zh/Python/" class="nav-link">笔记</a></div><div class="nav-item"><a href="/my-notebook/zh/Collect/" class="nav-link">收藏</a></div><div class="nav-item"><a href="/my-notebook/zh/AboutMe/" class="nav-link">关于我</a></div> <a href="https://github.com/VanLiuZhi/my-notebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>Python</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/my-notebook/zh/Python/collections.html" class="sidebar-link">collections模块</a></li><li><a href="/my-notebook/zh/Python-asyncio/" class="sidebar-link">异步与协程</a></li><li><a href="/my-notebook/zh/Python/Django.html" class="sidebar-link">Django 相关</a></li><li><a href="/my-notebook/zh/Python/Flask.html" class="sidebar-link">Flask</a></li><li><a href="/my-notebook/zh/Python/" class="sidebar-link">Python 笔记</a></li><li><a href="/my-notebook/zh/Python/virtualenv.html" class="sidebar-link">python 虚拟环境</a></li><li><a href="/my-notebook/zh/Python/pytest.html" class="sidebar-link">pytest</a></li><li><a href="/my-notebook/zh/Python-socket/" class="sidebar-link">Socket</a></li><li><a href="/my-notebook/zh/Python-threading/" class="active sidebar-link">线程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my-notebook/zh/Python-threading/#threading的属性和方法" class="sidebar-link">threading的属性和方法</a></li><li class="sidebar-sub-header"><a href="/my-notebook/zh/Python-threading/#thread实例的属性和方法" class="sidebar-link">thread实例的属性和方法</a></li><li class="sidebar-sub-header"><a href="/my-notebook/zh/Python-threading/#多线程情况" class="sidebar-link">多线程情况</a></li><li class="sidebar-sub-header"><a href="/my-notebook/zh/Python-threading/#线程安全" class="sidebar-link">线程安全</a></li><li class="sidebar-sub-header"><a href="/my-notebook/zh/Python-threading/#线程daemon" class="sidebar-link">线程daemon</a></li><li class="sidebar-sub-header"><a href="/my-notebook/zh/Python-threading/#join" class="sidebar-link">join</a></li><li class="sidebar-sub-header"><a href="/my-notebook/zh/Python-threading/#原子性" class="sidebar-link">原子性</a></li><li class="sidebar-sub-header"><a href="/my-notebook/zh/Python-threading/#队列" class="sidebar-link">队列</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my-notebook/zh/Python-threading/#实例方法" class="sidebar-link">实例方法</a></li></ul></li><li class="sidebar-sub-header"><a href="/my-notebook/zh/Python-threading/#本地线程" class="sidebar-link">本地线程</a></li><li class="sidebar-sub-header"><a href="/my-notebook/zh/Python-threading/#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/my-notebook/zh/Python-multiprocessing/" class="sidebar-link">进程</a></li><li><a href="/my-notebook/zh/Python/gunicorn.html" class="sidebar-link">gunicorn</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Docker</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>MongoDB</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>MySql</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Web</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Algorithm</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>ReadBook</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Mac工具</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Python工具</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>JavaScript工具</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Other </span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="线程">线程</h1> <p>使用标准库threading来创建线程。threading 库可以在单独的线程中执行任何的在 Python 中可以调用的对象。你可 以创建一个 Thread 对象并将你要执行的对象以 target 参数的形式提供给该对象。虽然python GIL 的存在，导致多线程同一时刻只能有一个线程获得解释器（在py2中，大概执行1000行字节码后，会释放解释器，当线程被阻塞的时候，会让出解释器，释放GIL）</p> <p>可以通过time.sleep(3)来阻塞线程</p> <p>一个简单例子：</p> <pre><code class="hljs python"><span class="hljs-keyword">import</span> threading

<span class="hljs-comment"># 计算密集型任务</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func</span><span class="hljs-params">()</span>:</span>
    a = [i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1111</span>)]
    print(<span class="hljs-string">'hello world'</span>)


t = threading.Thread(target=func)
t.start()
print(<span class="hljs-string">'sleep'</span>)
<span class="hljs-comment"># 此时创建列表a占用了解释器，先hello world 再 sleep</span>


<span class="hljs-comment"># 计算密集型任务</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func</span><span class="hljs-params">()</span>:</span>
    a = [i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">11111111111</span>)]
    print(<span class="hljs-string">'hello world'</span>)


t = threading.Thread(target=func)
t.start()
print(<span class="hljs-string">'sleep'</span>)
<span class="hljs-comment"># 这种情况，先打印sleep再是hello world（执行一定的字节码后，释放了解释器）</span></code></pre> <h2 id="threading的属性和方法">threading的属性和方法</h2> <ul><li>current_thread()  # 返回当前线程对象.</li> <li>main_thread()  # 返回主线程对象.</li> <li>active_count()  # 当前处于alive状态的线程个数.</li> <li>enumerate()  # 返回所有活着的线程的列表，不包括已经终止的线程和未开始的线程.</li> <li>get_ident()  # 返回当前线程ID，非0整数.</li></ul> <p>看一个例子：</p> <pre><code class="hljs python"><span class="hljs-keyword">import</span> threading

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment"># a = [i for i in range(1111)]</span>
    print(<span class="hljs-string">'current thread = {}'</span>.format(threading.current_thread()))
    print(<span class="hljs-string">'main thread = {}'</span>.format(threading.main_thread()), <span class="hljs-string">'"主线程对象"'</span>)
    print(<span class="hljs-string">'active count = {}'</span>.format(threading.active_count()), <span class="hljs-string">'"alive"'</span>)
    print(<span class="hljs-string">'hello world'</span>)


t = threading.Thread(target=func)
t.start()
print(<span class="hljs-string">'sleep'</span>)
print(<span class="hljs-string">'current thread = {}'</span>.format(threading.current_thread()))
print(<span class="hljs-string">'main thread = {}'</span>.format(threading.main_thread()), <span class="hljs-string">'"主线程对象"'</span>)
print(<span class="hljs-string">'active count = {}'</span>.format(threading.active_count()), <span class="hljs-string">'"alive"'</span>)</code></pre> <p>运行以上代码，每次的执行结果是不一样的，而且是print是线程不安全的。要解释这个问题，需要再了解一些线程相关的概念。</p> <h2 id="thread实例的属性和方法">thread实例的属性和方法</h2> <ul><li>name: 只是一个名称标识，可以重名，getName()、setName()来获取、设置这个名词。</li> <li>ident: 线程ID，它是非0整数。线程启动后才会有ID，否则为None。线程退出，此ID依旧可以访问。此ID可以重复使用。</li> <li>is_alive(): 返回线程是否活着。</li></ul> <p>通过threading.Thread()  我们创建了线程类的实例，像面向对象一样，可以有对应的方法，属性</p> <p><code>t = threading.Thread(target=func, name='my_thread', args=('1', ), kwargs={'a': 2})</code></p> <ul><li>start(): 启动线程。每一个线程必须且只能执行该方法一次。</li></ul> <p>开始线程活动。</p> <p>对每一个线程对象来说它只能被调用一次，它安排对象在一个另外的单独线程中调用run()方法（而非当前所处线程）。
当该方法在同一个线程对象中被调用超过一次时，会引发RuntimeError(运行时错误)。</p> <ul><li>run(): 运行线程函数。</li></ul> <p>代表了线程活动的方法。</p> <p>你可以在子类中重写此方法。标准run()方法调用了传递给对象的构造函数的可调对象作为目标参数，如果有这样的参数的话，顺序和关键字参数分别从args和kargs取得。</p> <p>start() 后，还会执行run。如果你重写线程类，在调用start和run的时候，加入打印代码，start执行的线程，会派生出子线程，在子线程中去执行run，配合threading.current_thread()可以看到整个过程。</p> <p>而run只在当前线程中执行。</p> <h2 id="多线程情况">多线程情况</h2> <p>继承Thread类，使用Extender的形式扩展start和run方法，观察执行情况。我们开启两个线程，然后start他们，利用threading.current_thread()获取当前线程，main_thread()返回主线程对象</p> <pre><code class="hljs python"><span class="hljs-keyword">import</span> threading
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> logging

logging.basicConfig(level=logging.NOTSET)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">worker</span><span class="hljs-params">()</span>:</span>
    count = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> <span class="hljs-keyword">True</span>:
        <span class="hljs-keyword">if</span> count &gt; <span class="hljs-number">5</span>:
            <span class="hljs-keyword">break</span>
        time.sleep(<span class="hljs-number">1</span>)
        count += <span class="hljs-number">1</span>
        <span class="hljs-comment"># print("worker running")</span>
        logging.info(<span class="hljs-string">"{} {} 主线程：{}"</span>.format(threading.current_thread().name, threading.current_thread().ident,
                                        threading.main_thread()))
        <span class="hljs-comment"># print(threading.current_thread().name, threading.current_thread().ident)</span>


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyThread</span><span class="hljs-params">(threading.Thread)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span><span class="hljs-params">(self)</span>:</span>
        print(<span class="hljs-string">'start~~~~~~~~~~~~~'</span>)
        super().start()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span><span class="hljs-params">(self)</span>:</span>
        print(<span class="hljs-string">'run~~~~~~~~~~~~~~~'</span>)
        super().run()


print(threading.main_thread())

t = MyThread(name=<span class="hljs-string">'worker'</span>, target=worker)
t2 = MyThread(name=<span class="hljs-string">'not worker'</span>, target=worker)
t.start()
t2.start()
t.join()
t2.join()

<span class="hljs-comment"># 输出结果</span>
<span class="hljs-comment"># &lt;_MainThread(MainThread, started 4587271616)&gt;</span>
<span class="hljs-comment"># start~~~~~~~~~~~~~</span>
<span class="hljs-comment"># run~~~~~~~~~~~~~~~</span>
<span class="hljs-comment"># start~~~~~~~~~~~~~</span>
<span class="hljs-comment"># run~~~~~~~~~~~~~~~</span>
<span class="hljs-comment"># INFO:root:worker 123145369858048 主线程：&lt;_MainThread(MainThread, started 4587271616)&gt;</span>
<span class="hljs-comment"># INFO:root:not worker 123145375113216 主线程：&lt;_MainThread(MainThread, started 4587271616)&gt;</span>
<span class="hljs-comment"># INFO:root:worker 123145369858048 主线程：&lt;_MainThread(MainThread, started 4587271616)&gt;</span>
<span class="hljs-comment"># INFO:root:not worker 123145375113216 主线程：&lt;_MainThread(MainThread, started 4587271616)&gt;</span>
<span class="hljs-comment"># INFO:root:worker 123145369858048 主线程：&lt;_MainThread(MainThread, started 4587271616)&gt;</span>
<span class="hljs-comment"># INFO:root:not worker 123145375113216 主线程：&lt;_MainThread(MainThread, started 4587271616)&gt;</span>
<span class="hljs-comment"># INFO:root:worker 123145369858048 主线程：&lt;_MainThread(MainThread, started 4587271616)&gt;</span>
<span class="hljs-comment"># INFO:root:not worker 123145375113216 主线程：&lt;_MainThread(MainThread, started 4587271616)&gt;</span>
<span class="hljs-comment"># INFO:root:worker 123145369858048 主线程：&lt;_MainThread(MainThread, started 4587271616)&gt;</span>
<span class="hljs-comment"># INFO:root:not worker 123145375113216 主线程：&lt;_MainThread(MainThread, started 4587271616)&gt;</span>
<span class="hljs-comment"># INFO:root:worker 123145369858048 主线程：&lt;_MainThread(MainThread, started 4587271616)&gt;</span>
<span class="hljs-comment"># INFO:root:not worker 123145375113216 主线程：&lt;_MainThread(MainThread, started 4587271616)&gt;</span></code></pre> <p>可以看到两个线程交替运行，如果使用print，你跑多次这个结果是不一样的。</p> <p>打印前可以加入threading.main_thread()，这样可以看到俩个线程都是主线程派生出来的子线程。</p> <p>换成run()方法后，结果如下：</p> <pre><code class="hljs python"><span class="hljs-keyword">import</span> threading
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> logging

logging.basicConfig(level=logging.NOTSET)


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">worker</span><span class="hljs-params">()</span>:</span>
    count = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> <span class="hljs-keyword">True</span>:
        <span class="hljs-keyword">if</span> count &gt; <span class="hljs-number">5</span>:
            <span class="hljs-keyword">break</span>
        time.sleep(<span class="hljs-number">1</span>)
        count += <span class="hljs-number">1</span>
        <span class="hljs-comment"># print("worker running")</span>
        <span class="hljs-comment"># print(threading.main_thread().name, threading.current_thread().name, threading.current_thread().ident)</span>
        logging.info(<span class="hljs-string">"{} {} 主线程：{}"</span>.format(threading.current_thread().name, threading.current_thread().ident,
                                        threading.main_thread()))


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyThread</span><span class="hljs-params">(threading.Thread)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span><span class="hljs-params">(self)</span>:</span>
        print(<span class="hljs-string">'start~~~~~~~~~~~~~'</span>)
        super().start()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span><span class="hljs-params">(self)</span>:</span>
        print(<span class="hljs-string">'run~~~~~~~~~~~~~~~'</span>)
        super().run()


t = MyThread(name=<span class="hljs-string">'worker'</span>, target=worker)
t2 = MyThread(name=<span class="hljs-string">'not worker'</span>, target=worker)
t.run()
t2.run()

<span class="hljs-comment"># run~~~~~~~~~~~~~~~</span>
<span class="hljs-comment"># INFO:root:MainThread 4705641920 主线程：&lt;_MainThread(MainThread, started 4705641920)&gt;</span>
<span class="hljs-comment"># INFO:root:MainThread 4705641920 主线程：&lt;_MainThread(MainThread, started 4705641920)&gt;</span>
<span class="hljs-comment"># INFO:root:MainThread 4705641920 主线程：&lt;_MainThread(MainThread, started 4705641920)&gt;</span>
<span class="hljs-comment"># INFO:root:MainThread 4705641920 主线程：&lt;_MainThread(MainThread, started 4705641920)&gt;</span>
<span class="hljs-comment"># INFO:root:MainThread 4705641920 主线程：&lt;_MainThread(MainThread, started 4705641920)&gt;</span>
<span class="hljs-comment"># run~~~~~~~~~~~~~~~</span>
<span class="hljs-comment"># INFO:root:MainThread 4705641920 主线程：&lt;_MainThread(MainThread, started 4705641920)&gt;</span>
<span class="hljs-comment"># INFO:root:MainThread 4705641920 主线程：&lt;_MainThread(MainThread, started 4705641920)&gt;</span>
<span class="hljs-comment"># INFO:root:MainThread 4705641920 主线程：&lt;_MainThread(MainThread, started 4705641920)&gt;</span>
<span class="hljs-comment"># INFO:root:MainThread 4705641920 主线程：&lt;_MainThread(MainThread, started 4705641920)&gt;</span>
<span class="hljs-comment"># INFO:root:MainThread 4705641920 主线程：&lt;_MainThread(MainThread, started 4705641920)&gt;</span>
<span class="hljs-comment"># INFO:root:MainThread 4705641920 主线程：&lt;_MainThread(MainThread, started 4705641920)&gt;</span>
<span class="hljs-comment"># INFO:root:MainThread 4705641920 主线程：&lt;_MainThread(MainThread, started 4705641920)&gt;</span></code></pre> <p>可以看到，run就是去调用函数，谁来调用呢？当然是<code>当前线程</code>了，可以看到 <code>print(threading.main_thread().name, threading.current_thread().name, threading.current_thread().ident)</code> 打印出来的都是主线程。</p> <p><strong>没有开新的线程，这就是普通函数调用，所以执行完t1.run()，然后执行t2.run()，这里就不是多线程。</strong></p> <p>当使用start方法启动线程后，进程内有多个活动的线程并行的工作，就是多线程。</p> <p>一个进程中至少有一个线程，并作为程序的入口，这个线程就是主线程。一个进程至少有一个<code>主线程</code>。其他线程称为<code>工作线程</code>。</p> <h2 id="线程安全">线程安全</h2> <p>使用print来运行上面的两个例子，本应该是一行行打印，但很多字符串打印在了一起，这说明print函数被打断了，被线程切换打断了。</p> <p>print函数分两步，第一步打印字符串，第二部换行，就在这之间，发生了线程的切换。</p> <p>说明print函数不是线程安全函数。</p> <p>print函数还没执行换行符，就被其它线程打断了，在python3中：</p> <p><code>def print(self, *args, sep=' ', end='\n', file=None)</code></p> <p>print变成了函数，结尾默认加‘\n’，你可以去改变这个参数，比如改成'', 打印结果就是一行的一串字符</p> <p>线程安全: 线程执行一段代码，不会产生不确定的结果，那这段代码就是线程安全的。在开发中，我们会使用标准库的logging来，打印信息，这个是线程安全的。</p> <h2 id="线程daemon">线程daemon</h2> <p>线程可以被标识为&quot;Daemon线程&quot;，<strong>Daemon线程表明整个Python主程序只有在Daemon子线程运行时可以退出</strong>。该属性值继承自父线程，可通过setDaemon()函数设定该值。</p> <p>daemon线程和non-daemon线程(注：这里的daemon不是Linux中的守护进程)：</p> <ul><li>进程靠线程执行代码，至少有一个主线程，其他线程是工作线程。</li> <li>主线程是第一个启动的线程。</li> <li>父线程：如果线程A中启动了一个线程B，A就是B的父线程。</li> <li>子线程：B就是A的子线程。</li> <li>python中构造线程的时候可以设置daemon属性，这个属性必须在start方法之前设置好。</li></ul> <p>daemon属性：表示线程是否是daemon线程，这个值必须在start()之前设置，否则引发RuntimeError异常。</p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>daemon=False 运行发现子线程依然执行，主线程已经执行完，但是主线程会一直等着子线程执行完
daemon=True 运行发现主线程执行完程序立即结束了</p></div> <p>实例方法：</p> <p>isDaemon()：是否是daemon线程。
setDaemon()：设置为daemon线程，必须在start方法之前设置。</p> <p>总结:</p> <p>线程具有一个daemon属性，可以显式设置为True或False，也可以不设置，不设置则取默认值None。</p> <p>如果不设置daemon，就取当前线程的daemon来设置它。子线程继承父线程的daemon值，作用和设置None一样。</p> <p>主线程是non-daemon线程，即daemon=False。</p> <p>从主线程创建的所有线程不设置daemon属性，则默认都是daemon=False，也就是non-daemon线程。</p> <p>python程序在没有活着的non-daemon线程运行时退出，也就是剩下的只能是daemon线程，主线程才能退出，否则主线程就只能等待。</p> <ul><li>如果有non-daemon线程的时候，主线程退出时，也不会杀掉所有daemon线程，直到所有non-daemon线程全部结束</li> <li>如果还有daemon线程，主线程需要退出，会结束所有 daemon线程，退出。</li></ul> <p>线程创建的时候<code>t = threading.Thread(target=func, daemon=False)</code>这个daemon不设置就是False</p> <p>子线程也是non-daemon，只要有线程是non-daemon，python程序就不会退出，如果还未执行完成的线程是daemon的，主线程执行完，就会退出，并杀掉所有daemon线程。</p> <p>Daemon线程会被粗鲁的直接结束，它所使用的资源（已打开文件、数据库事务等）无法被合理的释放。</p> <pre><code class="hljs python"><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> threading


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span><span class="hljs-params">(n)</span>:</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(n):
        print(i)
        time.sleep(<span class="hljs-number">1</span>)


t1 = threading.Thread(target=foo, args=(<span class="hljs-number">10</span>,), daemon=<span class="hljs-keyword">True</span>)
t1.start()
<span class="hljs-comment"># t1.join()  # 设置join.</span>
print(<span class="hljs-string">'Main Thread Exiting'</span>)</code></pre> <p>在这个例子中，子线程开始执行，然后主线程执行了打印，由于主线程执行完成了，而剩下的线程是daemon的，所以程序退出。把daemon = False或者不设置，结果就是打印了Main Thread Exiting后，子线程继续，打印1，2，3.....</p> <h2 id="join">join</h2> <ul><li>使用了join方法后，daemon线程执行完了，主线程才退出。</li> <li>join(timeout=None)，是线程的标准方法之一。</li> <li>一个线程中调用另一个线程的join方法，调用者将被阻塞，直到被调用线程终止。</li> <li>一个线程可以被join多次。</li> <li>timeout参数指定调用者等待多久，没有设置超时，就一直等待被调用线程结束。</li> <li>调用谁的join方法，就是join谁，就要等谁。</li></ul> <p>把上面例子的 <code>t1.join() # 设置join.</code> 放开，<code>print('Main Thread Exiting')</code> 要等子线程执行完成才执行。</p> <p>join ()方法：主线程A中，创建了子线程B，并且在主线程A中调用了B.join()，那么，主线程A会在调用的地方等待，直到子线程B完成操作后，才可以接着往下执行，那么在调用这个线程时可以使用被调用线程的join方法。</p> <p>总结：</p> <p>主要理解daemon join，不做处理的多线程，线程是并发的，daemon控制了主线程是否等待子线程执行完成，join控制了线程是否要组赛，主线程被阻塞了，就不会因为还剩daemon线程退出，因为主线程被阻塞了，他还没有执行完，所以这两个概念是互不冲突的（你可以设置超时时间，超时到了，主线程不再阻塞，就会杀掉daemon线程）。</p> <p>在主线程中创建了3个线程，3个线程执行了join，就是说主线程要等着3个线程完成才执行，3个线程中的A线程创建了线程a，那么a就是A的子线程，a中join A就要等a执行完成，主线程也被阻塞，在等A，即主线程等A，A等a。</p> <h2 id="原子性">原子性</h2> <p>python的大部分操作是原子性的，比如你对列表执行反向，排序，它不会被其它线程打断。</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">import</span> dis
dis<span class="token punctuation">.</span>dis<span class="token punctuation">(</span>foo<span class="token punctuation">)</span>
</code></pre></div><p>利用标准库的dis可以看python代码的字节码实现，一般操作由一条指令来完成，那么就是原子性，如果一个操作（对应python的一行或几行代码）需要多个指令（入栈，出栈，调用寄存器等），可能在入栈等某个指令的时候被其它线程打断，出现和预期不一样的效果。</p> <h2 id="队列">队列</h2> <p>标准库queue提供了队列支持，在py2中，通过import Queue来使用队列，在py3中，通过from queue import Queue，py3中，除了Queue类，还增加了queue.LifoQueue（LIFO后进先出队列），queue.PriorityQueue（优先级队列）</p> <h3 id="实例方法">实例方法</h3> <p><code>q = queue.Queue(3) # 创建队列，队列最大元素3个，默认为0，此时队列长度没有限制</code></p> <ul><li>queue.qsize() 返回队列的大小</li> <li>queue.empty() 如果队列为空，返回True，反之False</li> <li>queue.full() 如果队列满了，返回True，反之False</li> <li>queue.full 与 maxsize 大小对应</li> <li>queue.get([block[, timeout]])获取队列，timeout等待时间</li> <li>queue.get_nowait() 相当queue.get(False)</li> <li>queue.put(item) 写入队列，timeout等待时间</li> <li>queue.put_nowait(item) 相当queue.put(item, False)</li> <li>queue.task_done() 在完成一项工作之后，queue.task_done()函数向任务已经完成的队列发送一个信号</li> <li>queue.join() 实际上意味着等到队列为空，再执行别的操作</li></ul> <h2 id="本地线程">本地线程</h2> <p>不同的线程对内容的修改只在线程内发挥作用，线程之间互相不影响</p> <pre><code class="hljs python"><span class="hljs-keyword">import</span> threading

my_data = threading.local()
my_data.number = <span class="hljs-number">42</span>
print(my_data.number)
log = []

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">f</span><span class="hljs-params">()</span>:</span>
    my_data.number = <span class="hljs-number">11</span>
    log.append(my_data.number)
    print(id(my_data.number))

thread = threading.Thread(target=f)
thread.start()
thread.join()
print(log)
print(my_data.number)
print(id(my_data.number))

<span class="hljs-comment"># 42</span>
<span class="hljs-comment"># 4559721904</span>
<span class="hljs-comment"># [11]</span>
<span class="hljs-comment"># 42</span>
<span class="hljs-comment"># 4559722896</span></code></pre> <h2 id="总结">总结</h2> <p>所以线程的执行结果是有很多因素影响的，在你用默认操作的时候，如果进行了IO密集任务或是CPU密集任务，IO密集在等待时会释放GIL，CPU密集也会执行一定数量的字节码后释放一下GIL，由于线程并发的切换是操作系统控制的，所以有这样的编程需求的时候，务必配合join，daemon等控制程序，不然什么时候切换，这是说不准的。</p> <p>线程何时切换？一个线程无论何时开始睡眠或等待网络 I/O，其他线程总有机会获取 GIL 执行 Python 代码。这是协同式多任务处理。CPython 也还有抢占式多任务处理。如果一个线程不间断地在 Python 2 中运行 1000 字节码指令，或者不间断地在 Python 3 运行15 毫秒，那么它便会放弃 GIL，而其他线程可以运行。把这想象成旧日有多个线程但只有一个 CPU 时的时间片。</p> <ol><li><p>协同式多任务处理
当一项任务比如网络 I/O启动，而在长的或不确定的时间，没有运行任何 Python 代码的需要，一个线程便会让出GIL，从而其他线程可以获取 GIL 而运行 Python。这种礼貌行为称为协同式多任务处理，它允许并发；多个线程同时等待不同事件。</p></li> <li><p>抢占式多任务处理
Python线程可以主动释放 GIL，也可以先发制人抓取 GIL 。</p></li></ol> <p>让我们回顾下 Python 是如何运行的。你的程序分两个阶段运行。首先，Python文本被编译成一个名为字节码的简单二进制格式。第二，Python解释器的主回路，一个名叫 pyeval_evalframeex() 的函数，流畅地读取字节码，逐个执行其中的指令。当解释器通过字节码时，它会定期放弃GIL，而不需要经过正在执行代码的线程允许，这样其他线程便能运行。默认情况下，检测间隔是1000 字节码。所有线程都运行相同的代码，并以相同的方式定期从他们的锁中抽出。在 Python 3 GIL 的实施更加复杂，检测间隔不是一个固定数目的字节码，而是15 毫秒。然而，对于你的代码，这些差异并不显著。</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/my-notebook/zh/Python-socket/" class="prev">
          Socket
        </a></span> <span class="next"><a href="/my-notebook/zh/Python-multiprocessing/">
          进程
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/my-notebook/assets/js/55.c4a44499.js" defer></script><script src="/my-notebook/assets/js/app.123d9d81.js" defer></script>
  </body>
</html>
